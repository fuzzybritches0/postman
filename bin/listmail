#!/bin/bash

mailfolder="${HOME}/Mail"
#fromTag='"Max Muster" <maxmuster88@gmail.com>'

emaila() {
	all="${@}"
	begin=0
	for i in $( seq 1 ${#all} ); do
		(( ii = i - 1 ))
		if [ "${all:${ii}:1}" == ">" ]; then
			[ "${i}" -lt "${#all}" ] && echo ","
			begin=0
		fi
		[ "${begin}" -eq "1" ] && echo -n "${all:${ii}:1}"
		[ "${all:${ii}:1}" == "<" ] && begin=1
	done
	echo
}

reply() {
	message=0
        while IFS="\r\n" read line; do
		[ "${line:0:8}"  == "Subject:" ] && echo "${line}"
		if [ "${line:0:3}"  == "To:" ] && [ ! "${to}" ]; then
			to="${line:3}"
			[ ! "${fromTag}" ] && echo "From:${to}"
			[ "${fromTag}" ] && echo "From:${fromTag}"
		fi
		[ "${line:0:5}"  == "Date:" ] && [ ! "${date}" ] && date="${line:5}" && echo -n "Date: " && date -R
		[ "${line:0:5}"  == "From:" ] && [ ! "${from}" ] && from="${line:5}" && \
			echo -n "To: " && emaila ${from} 
		[ "${line:0:3}"  == "Cc:" ] && [ ! "${cc}" ] && cc="${line:3}" && \
						echo -n "Cc: " && emaila ${cc} 
		[ "${line:0:11}"  == "Message-ID:" ] && [ ! "${mid}" ] && mid="${line:11}" && \
			echo "In-Reply-To: ${mid}" && \
			echo "Message-ID: <${RANDOM}-${RANDOM}-${USER}@${HOSTNAME}>"
		[ "${message}" -eq "0" ] && [ "${#line}" -le "1" ] && message=1 && \
			echo && echo && echo "On ${date} ${from} wrote:"
		[ "${message}" -eq "1" ] && echo "> ${line}"
        done
}

process_head() {
	pointer=
	head=1
	while IFS="\r\n" read line; do
		if [ "${head}" == "1" ]; then
			[ "${#line}"  -le "1" ] && head=
			[ "${line:0:5}"  == "Date:" ] && header[0]="${line:5}" && pointer=0
			[ "${line:0:5}"  == "From:" ] && header[1]="${line:5}" && pointer=1
			[ "${line:0:8}"  == "Subject:" ] && header[2]="${line:8}" && pointer=2
			[ "${line:0:1}"  == " " ] && header[${pointer}]="${header[${pointer}]}${line}"
		fi
	done
	echo "::: ${header[2]}"
	echo "${header[1]} ::: ${header[0]}"
	echo
}

if [ "$( basename ${0} )" == "getmail" ]; then
	cd "${mailfolder}" && fetchmail -s -K -r Inbox || exit ${?}
	listmail ./new
	echo
	exit 0
fi

[ ! "${1}" ] || [ ! -d "${1}" ] && echo "no valid mail folder!" && exit 1

count=0
for file in ${1}/*; do
	if [ "${file}" != "${1}/*" ]; then
		if [ "$( basename ${0} )" == "readmail" ] && [ "${count}" -eq "${2}" ]; then
			vim -R ${file}
			exit 0
		elif [ "$( basename ${0} )" == "rmmail" ] && [ "${count}" -eq "${2}" ]; then
			rm ${file}
			exit 0
		elif [ "$( basename ${0} )" == "replymail" ] && [ "${count}" -eq "${2}" ]; then
			filere="${file/.eml}_reply.eml"
			filere="$( basename "${filere}" )"
			filere="${mailfolder}/draft/${filere}"
			cat "${file}" | reply > "${filere}"
			vim "${filere}"
			sendmail "${filere}"
			exit 0
		elif [ "$( basename ${0} )" == "listmail" ] && [ ! -d "${file}" ]; then
			echo -n "${count} "
			cat "${file}" | process_head "${count}"
		elif [ -d "${file}" ]; then
			echo "DIRECTORY: ${file}"
		fi
		(( count++ ))
	fi
done

[ "$( basename ${0} )" == "countmail" ] && echo "${count}"
